# Portfolio Playbook（组合调度手册）中文执行版

> 对应英文原文：[`docs/Portfolio Playbook.md`](../Portfolio%20Playbook.md)  
> 上一篇：[`docs/zh/Final_Production_Candidate_Package_CN.md`](./Final_Production_Candidate_Package_CN.md) ｜ 下一篇：[`docs/zh/Operations_Runbook_CN.md`](./Operations_Runbook_CN.md)

## 目标
为 S1-S7 建立“稳健优先（robustness-first）”组合层：动态分配资金给低相关策略桶，并在组合层统一控风险。

## 1) 组合分配策略
### 1.1 策略桶
- HFT 桶：S1, S2
- MFT 桶：S3, S4
- LFT 桶：S5, S6
- 事件桶（Event）：S7（战术叠加，硬上限）

### 1.2 风险平价（Risk Parity）桶权重
- 原始权重：`w_b_raw = 1 / sigma_b`
- 归一化：`w_b = w_b_raw / sum(w_b_raw)`
- 上限：HFT 40%，MFT 40%，LFT 45%，S7 20%；每个活跃桶最少 10%。

### 1.3 桶内策略权重
- 公式：`w_s_in_bucket = (1 / sigma_s) / sum(1 / sigma_s)`
- 历史不足（<100 笔）时，改为等权。
- 单策略组合级上限：默认 18%，激进档最高 22%。

### 1.4 单资产敞口上限
- BTC 30%、ETH 25%、SOL 18%、其他 15%、前三资产总和 60%。
- 若新订单会超限，先缩单；缩后小于最小下单额则拒单。

### 1.5 相关性节流
- 对齐分数（Signal alignment）`A`：最近24小时方向一致比例。
- 规则：
  1. `A >= 0.75`，新风险预算降 25%。
  2. `A >= 0.90`，新风险预算降 45%，并禁掉最低 edge 分策略。
  3. 策略两两平均相关系数 `>= 0.65`，全局仓位乘数 0.80。
  4. 同时触发 2+3：乘数锁到 0.60，且 15 分钟仅开 1 单。

## 2) 全局风险控制
- 日亏损软限 -2.0%（冻结新开仓2小时）；硬限 -3.0%（到次日UTC前停开仓）。
- 滚动回撤：>=6% 风险减半；>=9% 停开仓24小时；恢复条件是 <5% 且连续12小时非负PnL。
- 连亏冷却：4连亏 90分钟，6连亏 6小时，8连亏 24小时并降一档风险配置。
- 波动切换：高波动 z-score>=+1.5 连续3小时，降杠杆30%；极端波动 >=+2.2，降杠杆50%，并默认停 S2/S7 新单。

## 3) 执行安全层
- 超时重试：HFT 90s, MFT 180s, LFT 300s；最多2次，仓位依次降到90%、75%。
- 点差/滑点守卫：HFT 8/10 bps，MFT 15/20 bps，LFT 20/30 bps（点差/滑点）。
- 资金费率（Funding fee）钩子：若持有期预测资金费率过高，缩仓或拒单。

## 4) 部署档位
- 保守（Conservative）：1.5x，max_open_trades=6，风险预算0.8%。
- 平衡（Balanced）：2.5x，max_open_trades=10，风险预算1.4%。
- 激进（Aggressive）：3.5x，max_open_trades=14，风险预算2.1%。

## 5) Freqtrade 落地模式
- 使用一个 Orchestrator（编排控制器）服务：读取策略信号、计算风险状态、输出准入决策、记录审计日志。
- 建议循环：风险层每60秒，执行守卫每15秒。

## 6) 治理与变更
- 阈值改动 >10% 必须先模拟盘7天。
- 生产档位切换需要双人审批。
- breaker 关闭开关 12小时自动过期。
- 每周复盘：拒单Top5、回撤贡献Top5、相关性节流触发频率。

## 修正记录
- 英文原文无命令块，本中文版按同结构补充可执行规则；无路径/类名冲突项。

### 成功判定
- 组合日志中能持续看到 `allocation_state`、`risk_state`、`execution_guard_state` 三类状态，并且触发器按阈值生效。

### 失败排查（最常见3项）
1. 只做了单策略风控，没做组合级风控。
2. 相关性节流阈值未接入实时数据。
3. 档位切换后没同步更新仓位上限。

### 下一步动作
- 按《Operations Runbook》执行启动流程与值班监控。
